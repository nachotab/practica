ESTOY EN MI NUEVO BRANCH
/*Hacer que el primer día de la semana sea el domingo */
SET DATEFIRST 7;
INSERT INTO Comidas(ComensalId, IngestaId, CentroId, Fecha, Servir, CierreEmplatadoId, CreatedBy, CreatedOn, UnidadEnfermeriaId, PuestoId)
SELECT P.ComensalId, I.IngestaId, P.CentroId, F.Fecha,
    CASE
        WHEN
            EXISTS (
                SELECT 1
                FROM IntervencionesProgramadas
                WHERE Fecha <= F.Fecha AND FinalizadoEn IS NULL
                    AND NHC = P.NHC
                    AND IsDeleted = 0
            ) OR E.CierreEmplatadoId IS NOT NULL THEN 0
        ELSE P.DeliverMeals
    END AS Servir,
    E.CierreEmplatadoId, @0 AS CreatedBy, @1 AS CreatedOn, P.UnidadEnfermeriaId, P.PuestoId
FROM Comensales P
CROSS JOIN (VALUES (CAST('2020-11-24' as date))) F(Fecha)
CROSS APPLY (
    SELECT I.IngestaId, I.IngestaMinutosCierre
    FROM Ingestas I
    WHERE I.IsDeleted = 0 AND NOT EXISTS (
        SELECT 1
        FROM Comidas
        WHERE ComensalId = P.ComensalId AND IngestaId = I.IngestaId AND Fecha = F.Fecha)
) I
LEFT JOIN CierresEmplatado E ON I.IngestaId = E.IngestaId AND E.Fecha = F.Fecha
    AND E.CentroId = P.CentroId AND E.UnidadEnfermeriaId = P.UnidadEnfermeriaId
WHERE ( 
    (
        EXISTS (
            SELECT 1
            FROM ConfiguracionesUnidadesEnfermeria
            WHERE CentroId = P.CentroId AND UnidadEnfermeriaId = P.UnidadEnfermeriaId AND TipoId = @2
        )
        OR
        EXISTS (
            SELECT 1
            FROM ComensalDias CD
            INNER JOIN ComensalIngestas CI ON CD.Id = CI.DiaId
            -- Si es acompañante, usar la agenda del anfitrión
            WHERE CD.ComensalId = COALESCE(P.ComensalAdjuntoId, P.ComensalId) AND CD.DiaSemana = DATEPART(WEEKDAY, F.Fecha) - 1 AND CI.IngestaId = I.IngestaId
        )
        OR
        EXISTS (
            -- Si el anfitrión no tiene agenda, buscar las comidas creadas en ese día
            SELECT 1
            FROM Comidas
            WHERE Fecha = F.Fecha AND ComensalId = P.ComensalAdjuntoId AND IngestaId = I.IngestaId
        )
    ) ) AND ( P.CentroId = @3 )
 AND P.FechaHasta IS NULL
AND EXISTS (
    SELECT 1
    FROM AsignacionesDietas
    WHERE ComensalId = P.ComensalId AND FechaHasta IS NULL
)
AND NOT EXISTS (
    SELECT 1
    FROM Comidas
    WHERE ComensalId = P.ComensalId AND IngestaId = I.IngestaId AND Fecha = F.Fecha
)
ORDER BY F.Fecha, P.ComensalId, I.IngestaId;
PROBAMOS CON ESTA NUEVA MODIFICACIÓN.

NUEVA LINEA MODIFICACIÓN.
